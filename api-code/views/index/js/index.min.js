;

jQuery(function () {


    $("body").on('click', '[data-stopPropagation]', function (e) {
        e.stopPropagation();
    });

    // 滚动条
    const ps = new PerfectScrollbar('.lyear-layout-sidebar-scroll', {
        swipeEasing: false,
        suppressScrollX: true
    });

    // 侧边栏
    $(document).on('click', '.lyear-aside-toggler', function () {
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $("body").toggleClass('lyear-layout-sidebar-close');

        if ($('.lyear-mask-modal').length == 0) {
            $('<div class="lyear-mask-modal"></div>').prependTo('body');
        } else {
            $('.lyear-mask-modal').remove();
        }
    });

    // 遮罩层
    $(document).on('click', '.lyear-mask-modal', function () {
        $(this).remove();
        $('.lyear-layout-sidebar').toggleClass('lyear-aside-open');
        $('body').toggleClass('lyear-layout-sidebar-close');
    });

    // 侧边栏导航
    $(document).on('click', '.nav-item-has-subnav > a', function () {
        $subnavToggle = jQuery(this);
        $navHasSubnav = $subnavToggle.parent();
        $topHasSubNav = $subnavToggle.parents('.nav-item-has-subnav').last();
        $subnav = $navHasSubnav.find('.nav-subnav').first();
        $viSubHeight = $navHasSubnav.siblings().find('.nav-subnav:visible').outerHeight();
        $scrollBox = $('.lyear-layout-sidebar-scroll');
        $navHasSubnav.siblings().find('.nav-subnav:visible').slideUp(500).parent().removeClass('open');
        $subnav.slideToggle(300, function () {
            $navHasSubnav.toggleClass('open');

            // 新增滚动条处理
            var scrollHeight = 0;
            pervTotal = $topHasSubNav.prevAll().length,
                boxHeight = $scrollBox.outerHeight(),
                innerHeight = $('.sidebar-main').outerHeight(),
                thisScroll = $scrollBox.scrollTop(),
                thisSubHeight = $(this).outerHeight(),
                footHeight = 121;

            if (footHeight + innerHeight - boxHeight >= (pervTotal * 48)) {
                scrollHeight = pervTotal * 48;
            }
            if ($subnavToggle.parents('.nav-item-has-subnav').length == 1) {
                $scrollBox.animate({ scrollTop: scrollHeight }, 300);
            } else {
                // 子菜单操作
                if (typeof ($viSubHeight) != 'undefined' && $viSubHeight != null) {
                    scrollHeight = thisScroll + thisSubHeight - $viSubHeight;
                    $scrollBox.animate({ scrollTop: scrollHeight }, 300);
                } else {
                    if ((thisScroll + boxHeight - $scrollBox[0].scrollHeight) == 0) {
                        scrollHeight = thisScroll - thisSubHeight;
                        $scrollBox.animate({ scrollTop: scrollHeight }, 300);
                    }
                }
            }
        });
    });

    // 设置主题配色
    setTheme = function (input_name, data_name) {
        $("input[name='" + input_name + "']").click(function () {
            $('body').attr(data_name, $(this).val());
        });
    }
    setTheme('logo_bg', 'data-logobg');
    setTheme('header_bg', 'data-headerbg');
    setTheme('sidebar_bg', 'data-sidebarbg');

    // 选项卡
    $('#iframe-content').multitabs({
        iframe: true,
        nav: {
            backgroundColor: '#ffffff',
        },
        init: [{
            type: 'main',
            title: '首页',
            url: '/index/lyear_main'
        }]
    });


    let userComfig = Cookies.get('userThisComfig')
    localStorage.setItem('userComfig', userComfig)
    //用户配置图片区
    let thisUser = JSON.parse(localStorage.getItem('userComfig'))
    let src = `http://127.0.0.1:7100/router${thisUser.headPhoto}`
    let defaultSrc = `images/aaa.jpg`
    $('#leftTopPhoto').attr('src', src)
    $('#rightTopPhoto').attr('src', src)

    function IfUserPhoto(On,src,defaultSrc) {
        if(On === 1){
            $('#leftTopPhoto').attr('src', src)
            $('#rightTopPhoto').attr('src', src)
        }else{
            $('#leftTopPhoto').attr('src', defaultSrc)
            $('#rightTopPhoto').attr('src', defaultSrc)
        }
    }

    //用户默认头像像
    thisUser.headPhoto ? IfUserPhoto(1,src,defaultSrc) : IfUserPhoto(0,src,defaultSrc)
 
    //当前用户的用户名
    thisUser.nickname ? $('#idUserl').html(thisUser.nickname + `<span class="caret"></span>`) : $('#idUserl').html(thisUser.username + `<span class="caret"></span>`)


    //后台标题
    $('#webTitle').html(localStorage.getItem('webComfig'));







    $(document).on('click', '.nav-item .multitabs', function () {
        $('.nav-item').removeClass('active');
        $('.nav-subnav li').removeClass('active');
        $(this).parents('li').addClass('active');
        $(this).parents('.nav-item-has-subnav').addClass('open').first().addClass('active');
    });
});